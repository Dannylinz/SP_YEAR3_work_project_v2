<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Meganet Q&A (Topics)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    html, body { height: 100%; background: #f4f6f9; font-family: 'Poppins', sans-serif; }
    .page-wrap { min-height: 100vh; display: flex; flex-direction: column; }
    .content { flex: 1; }

    .topics-panel,
    .questions-panel {
      background: #fff; border: 1px solid #e3e6ea; border-radius: 10px; padding: 16px;
    }

    .topic-pill { cursor: pointer; }
    .topic-pill.active { background: #0d6efd; color: #fff; }

    .q-card {
      border: 1px solid #e9ecef; border-radius: 10px; padding: 12px 14px;
      transition: box-shadow .15s ease-in-out; background: #fff;
    }
    .q-card:hover { box-shadow: 0 4px 18px rgba(0,0,0,.06); }
    .q-title { cursor: pointer; margin: 0; font-weight: 600; }
    .q-meta { font-size: .8rem; color: #6c757d; }
    .q-answer { display: none; margin-top: 8px; white-space: pre-wrap; line-height: 1.35; }

    .admin-panel .card { border-radius: 10px; }
    .form-text { font-size: .8rem; }

    .flow-final-note {
      font-size: 0.9rem;
      color: #6c757d;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="page-wrap">

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" href="#">
          <img src="pictures/logo.png" alt="MegaNet Logo"
               style="height: 40px; width: auto; margin-right: 8px;">
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navMain">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a class="nav-link active" href="chatbox.html">FAQ</a></li>
            <li class="nav-item"><a class="nav-link" href="index.html">Dashboard</a></li>
            <li class="nav-item"><a class="nav-link" href="faq.html">Chat Board</a></li>
            <li class="nav-item"><a class="nav-link" href="sop.html">SOP Management</a></li>
            <li class="nav-item"><a class="nav-link" href="profile.html">Profile</a></li>

            <!-- ‚≠ê Updated Logout Button -->
            <li class="nav-item">
              <a class="nav-link" href="#" onclick="logout()">Logout</a>
            </li>

          </ul>
        </div>
      </div>
    </nav>

    <!-- Page -->
    <div class="content container py-4">
      <div class="row g-3">
        <!-- LEFT: Topics -->
        <div class="col-12 col-lg-3">
          <div class="topics-panel">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <h5 class="mb-0">Topics</h5>
              <span class="badge text-bg-light" id="topicCount">0</span>
            </div>

            <div id="topicList" class="d-flex flex-column gap-2 mb-3">
              <!-- Topic pills injected here -->
            </div>

            <!-- Admin: Add topic -->
            <div id="adminTopicTools" class="d-none">
              <hr/>
              <h6 class="mb-2">Add New Topic</h6>
              <div class="input-group mb-2">
                <input type="text" id="newTopicName" class="form-control" placeholder="e.g., IT"/>
                <button id="addTopicBtn" class="btn btn-primary">Add</button>
              </div>
              <div class="form-text">Only admins can add/delete topics.</div>
            </div>
          </div>
        </div>

        <!-- RIGHT: Questions -->
        <div class="col-12 col-lg-9">
          <div class="questions-panel">
            <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between mb-3">
              <h5 class="mb-0">
                <span id="currentTopicLabel">Select a topic</span>
              </h5>
              <div class="d-flex gap-2 align-items-center">
                <input type="text" id="searchBox" class="form-control form-control-sm" placeholder="Search questions..." style="min-width:220px;">
                <span class="badge text-bg-light" id="questionCount">0</span>
              </div>
            </div>

            <!-- Admin: Add question -->
            <div id="adminQuestionTools" class="admin-panel d-none mb-3">
              <div class="card">
                <div class="card-body">
                  <h6 class="mb-2">Add Question to <span id="adminTopicName">(none)</span></h6>
                  <div class="row g-2">
                    <div class="col-12 col-md-6">
                      <label class="form-label">Question</label>
                      <textarea id="qQuestion" class="form-control" rows="2" placeholder="Enter the question..."></textarea>
                    </div>
                    <div class="col-12 col-md-6">
                      <label class="form-label">Answer</label>
                      <textarea id="qAnswer" class="form-control" rows="2" placeholder="Enter the answer..."></textarea>
                    </div>
                    <div class="col-12 text-end">
                      <button id="addQuestionBtn" class="btn btn-success">Add Question</button>
                    </div>
                  </div>
                  <div class="form-text">Only admins can add/edit/delete questions.</div>
                </div>
              </div>
            </div>

            <!-- Questions list -->
            <div id="questionList" class="row g-2">
              <!-- Question cards injected here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="text-center text-muted py-3"><small>&copy; MegaNet</small></footer>
  </div>

  <!-- USER FLOW MODAL -->
  <div class="modal fade" id="flowModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="flowQuestionTitle">Guided Help</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p id="flowStepText" style="white-space: pre-wrap;"></p>
          <p id="flowFinalNote" class="flow-final-note d-none">
            This is the end of the guided conversation. If you're still stuck, please ask Danny or Debrae directly.
          </p>
        </div>
        <div class="modal-footer">
          <button id="flowNoBtn" type="button" class="btn btn-outline-secondary">No</button>
          <button id="flowYesBtn" type="button" class="btn btn-primary">Yes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ADMIN FLOW BUILDER MODAL -->
  <div class="modal fade" id="flowBuilderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Manage Guided Flow</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="mb-2"><strong>Question:</strong> <span id="builderQuestionText"></span></p>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Flow Steps</h6>
            <button id="builderAddStepBtn" class="btn btn-sm btn-success">Add Step</button>
          </div>
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th style="width:5%">ID</th>
                  <th style="width:40%">Step Text</th>
                  <th style="width:15%">Yes ‚Üí Step</th>
                  <th style="width:15%">No ‚Üí Step</th>
                  <th style="width:10%">Final?</th>
                  <th style="width:15%">Actions</th>
                </tr>
              </thead>
              <tbody id="builderStepsBody">
                <!-- Rows injected here -->
              </tbody>
            </table>
          </div>
          <small class="text-muted">
            Tip: Make your last step a final message like: ‚ÄúPlease ask Danny or Debrae directly‚Äù and mark it as <strong>Final</strong>.
          </small>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Basic auth context
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user) window.location.href = "login.html";
    const isAdmin = String(user.role_id) === "1";

    // Elements
    const topicList = document.getElementById("topicList");
    const topicCount = document.getElementById("topicCount");
    const questionList = document.getElementById("questionList");
    const questionCount = document.getElementById("questionCount");
    const currentTopicLabel = document.getElementById("currentTopicLabel");
    const adminTopicTools = document.getElementById("adminTopicTools");
    const adminQuestionTools = document.getElementById("adminQuestionTools");
    const adminTopicName = document.getElementById("adminTopicName");
    const newTopicName = document.getElementById("newTopicName");
    const addTopicBtn = document.getElementById("addTopicBtn");
    const addQuestionBtn = document.getElementById("addQuestionBtn");
    const qQuestion = document.getElementById("qQuestion");
    const qAnswer = document.getElementById("qAnswer");
    const searchBox = document.getElementById("searchBox");

    // Flow modal elements
    const flowModalEl = document.getElementById("flowModal");
    const flowModal = new bootstrap.Modal(flowModalEl);
    const flowQuestionTitle = document.getElementById("flowQuestionTitle");
    const flowStepText = document.getElementById("flowStepText");
    const flowFinalNote = document.getElementById("flowFinalNote");
    const flowYesBtn = document.getElementById("flowYesBtn");
    const flowNoBtn = document.getElementById("flowNoBtn");

    // Builder modal elements
    const flowBuilderModalEl = document.getElementById("flowBuilderModal");
    const flowBuilderModal = new bootstrap.Modal(flowBuilderModalEl);
    const builderQuestionText = document.getElementById("builderQuestionText");
    const builderStepsBody = document.getElementById("builderStepsBody");
    const builderAddStepBtn = document.getElementById("builderAddStepBtn");

    // Data state
    let topics = [];
    let currentTopic = null;
    let questions = []; 
    let currentFlowQuestion = null;
    let currentFlowStepId = null;
    let builderCurrentQuestion = null;
    let builderSteps = [];

    // Admin controls visibility
    if (isAdmin) {
      adminTopicTools.classList.remove("d-none");
      adminQuestionTools.classList.remove("d-none");
    }

    // Load topics
    async function loadTopics() {
      console.log("üì° Fetching topics...");
      const res = await fetch("/api/chatbox/topics");
      topics = await res.json();
      renderTopics();
      if (!currentTopic && topics.length > 0) {
        selectTopic(topics[0]);
      }
    }

    function renderTopics() {
      topicList.innerHTML = "";
      topicCount.textContent = topics.length;

      topics.forEach(t => {
        const row = document.createElement("div");
        row.className = "d-flex align-items-center justify-content-between border rounded px-2 py-2";

        const pill = document.createElement("span");
        pill.className = "badge text-bg-light topic-pill px-3 py-2";
        pill.textContent = t.topic_name || t.name;
        if (currentTopic && currentTopic.topic_id === t.topic_id) pill.classList.add("active");
        pill.onclick = () => selectTopic(t);

        row.appendChild(pill);

        if (isAdmin) {
          const delBtn = document.createElement("button");
          delBtn.className = "btn btn-sm btn-outline-danger";
          delBtn.textContent = "Delete";
          delBtn.onclick = async () => {
            if (!confirm(`Delete topic "${t.topic_name || t.name}" and all its questions?`)) return;
            await fetch(`/api/chatbox/topics/${t.topic_id}`, {
              method: "DELETE",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ user_id: user.user_id, role_id: user.role_id })
            });
            if (currentTopic && currentTopic.topic_id === t.topic_id) currentTopic = null;
            await loadTopics();
            questionList.innerHTML = "";
            questionCount.textContent = "0";
            currentTopicLabel.textContent = "Select a topic";
            adminTopicName.textContent = "(none)";
          };
          row.appendChild(delBtn);
        }

        topicList.appendChild(row);
      });
    }

    async function selectTopic(t) {
      currentTopic = t;
      document.querySelectorAll(".topic-pill").forEach(el => el.classList.remove("active"));
      setTimeout(() => {
        [...document.querySelectorAll(".topic-pill")]
          .find(el => el.textContent === (t.topic_name || t.name))
          ?.classList.add("active");
      });

      currentTopicLabel.textContent = `Topic: ${t.topic_name || t.name}`;
      if (isAdmin) adminTopicName.textContent = t.topic_name || t.name;
      await loadQuestions(t.topic_id);
    }

    addTopicBtn.onclick = async () => {
      const topic_name = (newTopicName.value || "").trim();
      if (!topic_name) return alert("Enter topic name.");
      console.log("üü¢ Adding topic:", topic_name);
      const res = await fetch("/api/chatbox/topics", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ topic_name, user_id: user.user_id, role_id: user.role_id, username: user.username })
      });
      if (!res.ok) {
        const err = await res.json().catch(()=>({message:"Error"}));
        alert(err.message || "Failed to add topic.");
        return;
      }
      newTopicName.value = "";
      await loadTopics();
    };

    async function loadQuestions(topic_id) {
      console.log("üì° Fetching questions for topic:", topic_id);
      const res = await fetch(`/api/chatbox/questions?topic_id=${encodeURIComponent(topic_id)}`);
      questions = await res.json();
      renderQuestions(questions);
    }

    function renderQuestions(list) {
      questionList.innerHTML = "";
      const term = (searchBox.value || "").toLowerCase().trim();
      let filtered = list;
      if (term) {
        filtered = list.filter(q =>
          (q.question || "").toLowerCase().includes(term) ||
          (q.answer || "").toLowerCase().includes(term) ||
          (q.username || "").toLowerCase().includes(term)
        );
      }

      questionCount.textContent = filtered.length;

      filtered.forEach((q, idx) => {
        const col = document.createElement("div");
        col.className = "col-12";

        const card = document.createElement("div");
        card.className = "q-card";

        const title = document.createElement("h6");
        title.className = "q-title";
        title.innerHTML = `<span class="text-primary">Q${idx + 1}.</span> ${escapeHtml(q.question || "")}`;
        title.onclick = () => {
          ansDiv.style.display = ansDiv.style.display === "none" ? "block" : "none";
        };

        const meta = document.createElement("div");
        const when = q.created_at ? new Date(q.created_at).toLocaleString() : "‚Äî";
        meta.className = "q-meta mb-1";
        meta.textContent = `By ${q.username || "Unknown"} ‚Ä¢ ${when}`;

        const ansDiv = document.createElement("div");
        ansDiv.className = "q-answer";
        ansDiv.textContent = q.answer || "";

        const flowBtn = document.createElement("button");
        flowBtn.className = "btn btn-sm btn-outline-primary mt-2 me-2";
        flowBtn.textContent = "Start Guided Help";
        flowBtn.onclick = () => {
          startGuidedFlow(q);
        };

        card.appendChild(title);
        card.appendChild(meta);
        card.appendChild(ansDiv);
        card.appendChild(flowBtn);

        if (isAdmin) {
          const controls = document.createElement("div");
          controls.className = "mt-2 d-flex flex-wrap gap-2";

          const editBtn = document.createElement("button");
          editBtn.className = "btn btn-sm btn-outline-warning";
          editBtn.textContent = "Edit";
          editBtn.onclick = async () => {
            const newQ = prompt("Edit question:", q.question || "");
            if (newQ === null) return;
            const newA = prompt("Edit answer:", q.answer || "");
            if (newA === null) return;
            const r = await fetch(`/api/chatbox/questions/${q.question_id}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                question: newQ, answer: newA,
                user_id: user.user_id, role_id: user.role_id
              })
            });
            if (!r.ok) {
              const e = await r.json().catch(()=>({message:"Error"}));
              alert(e.message || "Failed to update question.");
              return;
            }
            await loadQuestions(currentTopic.topic_id);
          };

          const delBtn = document.createElement("button");
          delBtn.className = "btn btn-sm btn-outline-danger";
          delBtn.textContent = "Delete";
          delBtn.onclick = async () => {
            if (!confirm("Delete this question?")) return;
            const r = await fetch(`/api/chatbox/questions/${q.question_id}`, {
              method: "DELETE",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ user_id: user.user_id, role_id: user.role_id })
            });
            if (!r.ok) {
              const e = await r.json().catch(()=>({message:"Error"}));
              alert(e.message || "Failed to delete question.");
              return;
            }
            await loadQuestions(currentTopic.topic_id);
          };

          const manageFlowBtn = document.createElement("button");
          manageFlowBtn.className = "btn btn-sm btn-outline-secondary";
          manageFlowBtn.textContent = "Manage Flow";
          manageFlowBtn.onclick = () => {
            openFlowBuilder(q);
          };

          controls.appendChild(editBtn);
          controls.appendChild(delBtn);
          controls.appendChild(manageFlowBtn);
          card.appendChild(controls);
        }

        col.appendChild(card);
        questionList.appendChild(col);
      });
    }

    addQuestionBtn.onclick = async () => {
      if (!currentTopic) return alert("Select a topic first.");
      const ques = (qQuestion.value || "").trim();
      const ans = (qAnswer.value || "").trim();
      if (!ques || !ans) return alert("Enter both question and answer.");
      const r = await fetch("/api/chatbox/questions", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          topic_id: currentTopic.topic_id,
          question: ques,
          answer: ans,
          user_id: user.user_id,
          role_id: user.role_id,
          username: user.username
        })
      });
      if (!r.ok) {
        const e = await r.json().catch(()=>({message:"Error"}));
        alert(e.message || "Failed to add question.");
        return;
      }
      qQuestion.value = "";
      qAnswer.value = "";
      await loadQuestions(currentTopic.topic_id);
    };

    searchBox.addEventListener("input", () => renderQuestions(questions));

    function escapeHtml(unsafe = "") {
      return unsafe
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    async function startGuidedFlow(question) {
      currentFlowQuestion = question;
      flowQuestionTitle.textContent = question.question || "Guided Help";
      flowFinalNote.classList.add("d-none");
      flowYesBtn.disabled = false;
      flowNoBtn.disabled = false;

      try {
        const res = await fetch(`/api/chatbox/flow/start/${question.question_id}`);
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          alert(data.message || "No guided flow defined for this question yet.");
          return;
        }
        const data = await res.json();
        const step = data.step;
        currentFlowStepId = step.step_id;
        flowStepText.textContent = step.step_text || "";
        if (step.is_final || (!step.yes_next_step && !step.no_next_step)) {
          flowYesBtn.disabled = true;
          flowNoBtn.disabled = true;
          flowFinalNote.classList.remove("d-none");
        }
        flowModal.show();
      } catch (err) {
        console.error("‚ùå startGuidedFlow error:", err);
        alert("Error starting guided flow.");
      }
    }

    async function handleFlowChoice(choice) {
      if (!currentFlowStepId) return;
      try {
        const res = await fetch(`/api/chatbox/flow/next/${currentFlowStepId}/${choice}`);
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          alert(data.message || "Error progressing guided flow.");
          return;
        }
        const data = await res.json();
        const step = data.step;
        currentFlowStepId = step.step_id;
        flowStepText.textContent = step.step_text || "";

        const isEnd = data.end || step.is_final || (!step.yes_next_step && !step.no_next_step);
        if (isEnd) {
          flowYesBtn.disabled = true;
          flowNoBtn.disabled = true;
          flowFinalNote.classList.remove("d-none");
        } else {
          flowYesBtn.disabled = false;
          flowNoBtn.disabled = false;
          flowFinalNote.classList.add("d-none");
        }
      } catch (err) {
        console.error("‚ùå handleFlowChoice error:", err);
        alert("Error getting next step.");
      }
    }

    flowYesBtn.addEventListener("click", () => handleFlowChoice("yes"));
    flowNoBtn.addEventListener("click", () => handleFlowChoice("no"));

    flowModalEl.addEventListener("hidden.bs.modal", () => {
      currentFlowStepId = null;
      currentFlowQuestion = null;
      flowStepText.textContent = "";
      flowFinalNote.classList.add("d-none");
    });

    async function openFlowBuilder(question) {
      if (!isAdmin) return;
      builderCurrentQuestion = question;
      builderQuestionText.textContent = question.question || "";
      await loadBuilderSteps(question.question_id);
      flowBuilderModal.show();
    }

    async function loadBuilderSteps(question_id) {
      builderStepsBody.innerHTML = "";
      builderSteps = [];
      try {
        const res = await fetch(`/api/chatbox/flow/${question_id}`);
        if (!res.ok) return;
        builderSteps = await res.json();
        renderBuilderSteps();
      } catch (err) {
        console.error("‚ùå loadBuilderSteps error:", err);
      }
    }

    function renderBuilderSteps() {
      builderStepsBody.innerHTML = "";

      const stepIds = builderSteps.map(s => s.step_id);

      builderSteps.forEach(step => {
        const tr = document.createElement("tr");

        const tdId = document.createElement("td");
        tdId.textContent = step.step_id;
        tr.appendChild(tdId);

        const tdText = document.createElement("td");
        const ta = document.createElement("textarea");
        ta.className = "form-control form-control-sm";
        ta.rows = 2;
        ta.value = step.step_text || "";
        tdText.appendChild(ta);
        tr.appendChild(tdText);

        const tdYes = document.createElement("td");
        const selYes = document.createElement("select");
        selYes.className = "form-select form-select-sm";
        const optNoneYes = document.createElement("option");
        optNoneYes.value = "";
        optNoneYes.textContent = "(none)";
        selYes.appendChild(optNoneYes);
        stepIds.forEach(id => {
          const opt = document.createElement("option");
          opt.value = id;
          opt.textContent = id;
          selYes.appendChild(opt);
        });
        if (step.yes_next_step) selYes.value = step.yes_next_step;
        tdYes.appendChild(selYes);
        tr.appendChild(tdYes);

        const tdNo = document.createElement("td");
        const selNo = document.createElement("select");
        selNo.className = "form-select form-select-sm";
        const optNoneNo = document.createElement("option");
        optNoneNo.value = "";
        optNoneNo.textContent = "(none)";
        selNo.appendChild(optNoneNo);
        stepIds.forEach(id => {
          const opt = document.createElement("option");
          opt.value = id;
          opt.textContent = id;
          selNo.appendChild(opt);
        });
        if (step.no_next_step) selNo.value = step.no_next_step;
        tdNo.appendChild(selNo);
        tr.appendChild(tdNo);

        const tdFinal = document.createElement("td");
        const finalCheck = document.createElement("input");
        finalCheck.type = "checkbox";
        finalCheck.className = "form-check-input";
        finalCheck.checked = !!step.is_final;
        tdFinal.appendChild(finalCheck);
        tr.appendChild(tdFinal);

        const tdActions = document.createElement("td");
        const saveBtn = document.createElement("button");
        saveBtn.className = "btn btn-sm btn-primary me-1 mb-1";
        saveBtn.textContent = "Save";
        saveBtn.onclick = async () => {
          await saveBuilderStep(step.step_id, ta.value, selYes.value, selNo.value, finalCheck.checked);
        };

        const delBtn = document.createElement("button");
        delBtn.className = "btn btn-sm btn-outline-danger mb-1";
        delBtn.textContent = "Delete";
        delBtn.onclick = async () => {
          if (!confirm("Delete this step?")) return;
          await deleteBuilderStep(step.step_id);
        };

        tdActions.appendChild(saveBtn);
        tdActions.appendChild(delBtn);
        tr.appendChild(tdActions);

        builderStepsBody.appendChild(tr);
      });
    }

    async function saveBuilderStep(step_id, text, yesId, noId, isFinal) {
      if (!text.trim()) {
        alert("Step text cannot be empty.");
        return;
      }
      try {
        const r = await fetch(`/api/chatbox/flow/${step_id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            step_text: text.trim(),
            yes_next_step: yesId || null,
            no_next_step: noId || null,
            is_final: isFinal,
            role_id: user.role_id
          })
        });
        if (!r.ok) {
          const e = await r.json().catch(()=>({message:"Error"}));
          alert(e.message || "Failed to update step.");
          return;
        }
        await loadBuilderSteps(builderCurrentQuestion.question_id);
      } catch (err) {
        console.error("‚ùå saveBuilderStep error:", err);
        alert("Error saving step.");
      }
    }

    async function deleteBuilderStep(step_id) {
      try {
        const r = await fetch(`/api/chatbox/flow/${step_id}`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ role_id: user.role_id })
        });
        if (!r.ok) {
          const e = await r.json().catch(()=>({message:"Error"}));
          alert(e.message || "Failed to delete step.");
          return;
        }
        await loadBuilderSteps(builderCurrentQuestion.question_id);
      } catch (err) {
        console.error("‚ùå deleteBuilderStep error:", err);
        alert("Error deleting step.");
      }
    }

    builderAddStepBtn.addEventListener("click", async () => {
      if (!builderCurrentQuestion) return;
      const text = prompt("Enter step text (e.g., 'Can you access it now?')");
      if (!text) return;
      try {
        const r = await fetch("/api/chatbox/flow", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            question_id: builderCurrentQuestion.question_id,
            step_text: text.trim(),
            yes_next_step: null,
            no_next_step: null,
            is_final: false,
            role_id: user.role_id
          })
        });
        if (!r.ok) {
          const e = await r.json().catch(()=>({message:"Error"}));
          alert(e.message || "Failed to add step.");
          return;
        }
        await loadBuilderSteps(builderCurrentQuestion.question_id);
      } catch (err) {
        console.error("‚ùå builderAddStep error:", err);
        alert("Error adding step.");
      }
    });

    // ‚≠ê REAL LOGOUT FUNCTION
    function logout() {
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = "login.html";
    }

    // Boot
    loadTopics();
  </script>

  <script src="js/auth.js"></script>
</body>
</html>
