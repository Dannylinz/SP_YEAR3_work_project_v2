<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin - Leave Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; font-family: sans-serif; }
        .container { margin-top: 50px; }
        .status-pending { color: #856404; background-color: #fff3cd; padding: 4px 8px; border-radius: 4px; font-weight: 600; }
        .status-approved { color: #155724; background-color: #d4edda; padding: 4px 8px; border-radius: 4px; font-weight: 600; }
        .status-rejected { color: #721c24; background-color: #f8d7da; padding: 4px 8px; border-radius: 4px; font-weight: 600; }
        
        /* Ensures the View/Download buttons look clean */
        .btn-group-sm > .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üõ°Ô∏è Leave Approval Dashboard</h2>
        <a href="leave.html" class="btn btn-outline-secondary">Back to Calendar</a>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>User ID</th>
                        <th>Type</th>
                        <th>Date</th>
                        <th>Reason</th>
                        <th>Attachment</th> 
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="leaveTableBody">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const user = JSON.parse(localStorage.getItem("user"));

    // Check if user is logged in and is an Admin (Role 1)
    if (!user || String(user.role_id) !== "1") {
        alert("Unauthorized Access. Admin only.");
        window.location.href = "leave.html";
    }

    async function fetchAllLeaves() {
        try {
            const res = await fetch(`/api/leaves?user_id=${user.user_id}&role_id=${user.role_id}`);
            const data = await res.json();
            const tbody = document.getElementById("leaveTableBody");
            tbody.innerHTML = "";

            data.forEach(leave => {
                const isPending = leave.status === 'pending';
                
                // Logic for View and Download options
                let attachmentHtml = `<span class="text-muted small">No file</span>`;
                
                if (leave.file_path) {
                    attachmentHtml = `
                        <div class="btn-group btn-group-sm" role="group">
                            <a href="${leave.file_path}" target="_blank" class="btn btn-outline-primary" title="View File">
                                üëÅÔ∏è View
                            </a>
                            <a href="${leave.file_path}" download class="btn btn-primary" title="Download File">
                                üì• Download
                            </a>
                        </div>
                    `;
                }

                tbody.innerHTML += `
                    <tr>
                        <td><strong>#${leave.user_id}</strong></td>
                        <td><span class="badge bg-secondary">${leave.leave_type}</span></td>
                        <td>${new Date(leave.leave_date).toLocaleDateString()}</td>
                        <td><small>${leave.reason || '-'}</small></td>
                        <td>${attachmentHtml}</td> 
                        <td><span class="status-${leave.status}">${leave.status.toUpperCase()}</span></td>
                        <td>
                            ${isPending ? `
                                <button class="btn btn-success btn-sm me-1" onclick="updateStatus(${leave.leave_id}, 'approved')">Approve</button>
                                <button class="btn btn-danger btn-sm" onclick="updateStatus(${leave.leave_id}, 'rejected')">Reject</button>
                            ` : `<small class="text-muted">Processed</small>`}
                        </td>
                    </tr>
                `;
            });
        } catch (err) {
            console.error("Fetch Error:", err);
        }
    }

    async function updateStatus(leaveId, newStatus) {
        if (!confirm(`Are you sure you want to ${newStatus} this request?`)) return;

        try {
            const res = await fetch(`/api/leaves/${leaveId}/status`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    status: newStatus,
                    user_id: user.user_id, 
                    role_id: user.role_id  
                })
            });

            if (res.ok) {
                alert(`Leave ${newStatus} successfully! Notification sent.`);
                fetchAllLeaves();
            } else {
                const errorData = await res.json();
                alert("Update failed: " + errorData.message);
            }
        } catch (err) {
            console.error("Update Error:", err);
            alert("Error connecting to server.");
        }
    }

    fetchAllLeaves();
</script>
</body>
</html>