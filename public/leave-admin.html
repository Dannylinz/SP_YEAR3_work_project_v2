<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin - Leave Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; font-family: sans-serif; padding-bottom: 50px; }
        .container { margin-top: 50px; }
        .status-pending { color: #856404; background-color: #fff3cd; padding: 4px 8px; border-radius: 4px; font-weight: 600; }
        .status-approved { color: #155724; background-color: #d4edda; padding: 4px 8px; border-radius: 4px; font-weight: 600; }
        .status-rejected { color: #721c24; background-color: #f8d7da; padding: 4px 8px; border-radius: 4px; font-weight: 600; }
        .btn-group-sm > .btn { padding: 0.25rem 0.5rem; font-size: 0.75rem; }
    </style>
</head>
<body>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üõ°Ô∏è Leave Approval Dashboard</h2>
        <a href="leave.html" class="btn btn-outline-secondary">Back to Calendar</a>
    </div>

    <div class="card shadow-sm mb-5">
        <div class="card-header bg-white"><strong>All Leave Requests</strong></div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>User</th>
                            <th>Type</th>
                            <th>Dates</th>
                            <th>Days</th> <th>Reason</th>
                            <th>Attachment</th> 
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="leaveTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-primary">
        <div class="card-header bg-primary text-white"><strong>üìä Staff Annual Leave Balances</strong></div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr class="table-light">
                            <th>Staff Name</th>
                            <th>Annual Taken</th>
                            <th>Remaining (of 21)</th>
                            <th>Status Bar</th>
                        </tr>
                    </thead>
                    <tbody id="staffSummaryBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const user = JSON.parse(localStorage.getItem("user"));

    // Security Check
    if (!user || String(user.role_id) !== "1") {
        alert("Unauthorized Access. Admin only.");
        window.location.href = "leave.html";
    }

    async function fetchAllData() {
        try {
            const res = await fetch(`/api/leaves?user_id=${user.user_id}&role_id=${user.role_id}`);
            const data = await res.json();
            
            renderApprovalTable(data);
            renderStaffSummary(data);
        } catch (err) { 
            console.error("Fetch Error:", err); 
        }
    }

    function renderApprovalTable(data) {
        const tbody = document.getElementById("leaveTableBody");
        tbody.innerHTML = "";

        data.forEach(leave => {
            const isPending = leave.status === 'pending';
            
            const cleanStart = leave.leave_date.split('T')[0];
            const cleanEnd = leave.end_date ? leave.end_date.split('T')[0] : cleanStart;

            const dateDisplay = (cleanEnd === cleanStart) 
                ? cleanStart 
                : `${cleanStart} to ${cleanEnd}`;
            
            // Logic: Use the days_count from DB for display
            const daysDisplay = parseFloat(leave.days_count || 1).toFixed(1);

            tbody.innerHTML += `
                <tr>
                    <td><strong>${leave.username || '#' + leave.user_id}</strong></td>
                    <td><span class="badge bg-secondary">${leave.leave_type}</span></td>
                    <td>${dateDisplay}</td>
                    <td><span class="fw-bold text-dark">${daysDisplay}</span></td>
                    <td><small>${leave.reason || '-'}</small></td>
                    <td>${leave.file_path ? `<a href="${leave.file_path}" target="_blank">View</a>` : 'No file'}</td> 
                    <td><span class="status-${leave.status}">${leave.status.toUpperCase()}</span></td>
                    <td>
                        ${isPending ? `
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-success" onclick="updateStatus(${leave.leave_id}, 'approved')">Approve</button>
                                <button class="btn btn-danger" onclick="updateStatus(${leave.leave_id}, 'rejected')">Reject</button>
                            </div>
                        ` : `<small class="text-muted">Processed</small>`}
                    </td>
                </tr>
            `;
        });
    }

    function renderStaffSummary(data) {
        const summaryBody = document.getElementById("staffSummaryBody");
        const stats = {};

        data.forEach(l => {
            if (!stats[l.username]) stats[l.username] = 0;
            
            // FIX: Use the 'days_count' field from the database instead of calculating from dates
            if (l.leave_type === "Annual Leave" && l.status === "approved") {
                const count = l.days_count != null ? parseFloat(l.days_count) : 0;
                
                // Fallback for older entries that might not have days_count
                if (count === 0) {
                    const s = l.leave_date.split('T')[0].split('-').map(Number);
                    const e = (l.end_date || l.leave_date).split('T')[0].split('-').map(Number);
                    const d1 = Date.UTC(s[0], s[1]-1, s[2]);
                    const d2 = Date.UTC(e[0], e[1]-1, e[2]);
                    stats[l.username] += (Math.round((d2 - d1) / (1000 * 60 * 60 * 24)) + 1);
                } else {
                    stats[l.username] += count;
                }
            }
        });

        summaryBody.innerHTML = Object.keys(stats).map(name => {
            const taken = stats[name];
            const remaining = (21 - taken).toFixed(1); // Use toFixed for decimals
            const progress = Math.min((taken / 21) * 100, 100);
            
            return `
                <tr>
                    <td><strong>${name}</strong></td>
                    <td>${taken.toFixed(1)} Days</td>
                    <td class="text-primary fw-bold">${remaining} Days</td>
                    <td>
                        <div class="progress" style="height: 12px;">
                            <div class="progress-bar ${progress > 80 ? 'bg-danger' : 'bg-primary'}" 
                                 role="progressbar" 
                                 style="width: ${progress}%">
                            </div>
                        </div>
                    </td>
                </tr>
            `;
        }).join('') || '<tr><td colspan="4" class="text-center">No leave data found</td></tr>';
    }

    async function updateStatus(leaveId, newStatus) {
        if (!confirm(`Are you sure you want to ${newStatus} this request?`)) return;
        
        try {
            const res = await fetch(`/api/leaves/${leaveId}/status`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    status: newStatus, 
                    user_id: user.user_id, 
                    role_id: user.role_id 
                })
            });
            
            if (res.ok) {
                fetchAllData();
            } else {
                const errData = await res.json();
                alert("Error: " + (errData.message || "Failed to update status."));
            }
        } catch (err) { 
            console.error("Update Status Error:", err);
            alert("Connection error. Check console.");
        }
    }

    fetchAllData();
</script>
</body>
</html>