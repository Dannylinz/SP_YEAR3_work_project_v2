<!DOCTYPE html>
<html>
<head>
  <title>SOP Page</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .category { margin-bottom: 20px; }
    .category-title { font-weight: bold; cursor: pointer; font-size: 1.2em; }
    .sop-list { margin-left: 20px; display: none; }
    .sop-item { margin-bottom: 5px; }
    input, textarea, select { margin: 5px 0; width: 300px; }
    button { margin: 5px 0; }
    #message { font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>

<h1>SharePoint-style SOP Page</h1>

<div id="message"></div>

<h2>Add Category</h2>
<input type="text" id="categoryName" placeholder="Category Name">
<button id="addCategoryBtn">Add Category</button>

<h2>Add SOP</h2>
<select id="categorySelect">
  <option value="">Select Category</option>
</select><br>
<input type="text" id="sopTitle" placeholder="SOP Title"><br>
<textarea id="sopContent" placeholder="SOP Content"></textarea><br>
<button id="addSOPBtn">Add SOP</button>

<hr>
<h2>All SOPs</h2>
<div id="categoriesContainer"></div>

<script>
const message = document.getElementById("message");
const categoriesContainer = document.getElementById("categoriesContainer");
const categorySelect = document.getElementById("categorySelect");

const user = JSON.parse(localStorage.getItem("user"));
if (!user) {
  window.location.href = "login.html";
}

// ----------------------------
// Load categories into dropdown
async function loadCategories() {
  try {
    const res = await fetch("/api/sops/category"); // Backend must return array of categories
    const categories = await res.json();

    // Clear and reset dropdown
    categorySelect.innerHTML = '<option value="">Select Category</option>';
    categories.forEach(cat => {
      const option = document.createElement("option");
      option.value = cat.category_id;
      option.textContent = cat.category_name;
      categorySelect.appendChild(option);
    });
  } catch (err) {
    console.error("Error loading categories:", err);
    message.style.color = "red";
    message.textContent = "Failed to load categories";
  }
}

// ----------------------------
// Load SOPs grouped by category
async function loadSOPs() {
  try {
    const res = await fetch("/api/sops");
    const sops = await res.json();

    // Group SOPs by category
    const categoriesMap = {};
    sops.forEach(sop => {
      const catName = sop.category_name || "Uncategorized";
      if (!categoriesMap[catName]) categoriesMap[catName] = [];
      categoriesMap[catName].push(sop);
    });

    categoriesContainer.innerHTML = "";

    for (const [catName, sopList] of Object.entries(categoriesMap)) {
      const div = document.createElement("div");
      div.className = "category";
      div.innerHTML = `
        <div class="category-title">${catName}</div>
        <div class="sop-list">
          ${sopList.map(sop => `<div class="sop-item"><strong>${sop.title}</strong> - ${sop.content}</div>`).join('')}
        </div>
      `;
      categoriesContainer.appendChild(div);

      const titleDiv = div.querySelector(".category-title");
      const sopListDiv = div.querySelector(".sop-list");
      titleDiv.addEventListener("click", () => {
        sopListDiv.style.display = sopListDiv.style.display === "none" ? "block" : "none";
      });
    }
  } catch (err) {
    console.error(err);
    message.style.color = "red";
    message.textContent = "Failed to load SOPs";
  }
}

// ----------------------------
// Add new category
document.getElementById("addCategoryBtn").addEventListener("click", async () => {
  const categoryName = document.getElementById("categoryName").value.trim();
  if (!categoryName) return alert("Enter category name");

  try {
    const res = await fetch("/api/sops/category", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ category_name: categoryName })
    });
    const result = await res.json();
    message.style.color = res.ok ? "green" : "red";
    message.textContent = result.message;
    document.getElementById("categoryName").value = "";

    await loadCategories(); // refresh dropdown
    await loadSOPs();       // refresh SOP list
  } catch (err) {
    console.error(err);
    message.style.color = "red";
    message.textContent = "Error adding category";
  }
});

// ----------------------------
// Add new SOP
document.getElementById("addSOPBtn").addEventListener("click", async () => {
  const title = document.getElementById("sopTitle").value.trim();
  const content = document.getElementById("sopContent").value.trim();
  const category_id = categorySelect.value;

  if (!title || !category_id) return alert("Enter title and select category");

  try {
    const res = await fetch("/api/sops", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ title, content, category_id })
    });
    const result = await res.json();
    message.style.color = res.ok ? "green" : "red";
    message.textContent = result.message;

    document.getElementById("sopTitle").value = "";
    document.getElementById("sopContent").value = "";

    await loadSOPs();
  } catch (err) {
    console.error(err);
    message.style.color = "red";
    message.textContent = "Error adding SOP";
  }
});

// ----------------------------
// Initial load
loadCategories();
loadSOPs();
</script>
</body>
</html>
