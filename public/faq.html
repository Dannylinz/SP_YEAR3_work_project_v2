<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meganet Chat Board üí¨</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background: #f4f6f9;
      font-family: 'Poppins', sans-serif;
    }

    .chat-container {
      max-width: 800px;
      margin: 40px auto;
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      padding: 25px;
    }

    .message-wrapper {
      display: flex;
      margin-bottom: 12px;
    }

    .message {
      max-width: 70%;
      padding: 10px 15px;
      border-radius: 15px;
      word-wrap: break-word;
    }

    .message-left {
      background: #f1f3f6;
      align-self: flex-start;
      border-top-left-radius: 0;
    }

    .message-right {
      background: #cfe2ff;
      margin-left: auto;
      align-self: flex-end;
      border-top-right-radius: 0;
      text-align: right;
    }

    .message img {
      max-width: 200px;
      border-radius: 10px;
      margin-top: 5px;
    }

    .file-link {
      display: block;
      color: #0d6efd;
      text-decoration: underline;
      margin-top: 5px;
      word-break: break-all;
    }

    .message-header {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 5px;
    }

    .timestamp {
      font-size: 0.75rem;
      color: #888;
      margin-top: 4px;
    }

    .search-box {
      margin-bottom: 20px;
    }

    .btn-sm {
      font-size: 0.75rem;
      padding: 2px 6px;
    }

    #filePreview {
      font-size: 0.8rem;
      color: #555;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="text-primary fw-bold">üí¨ Meganet Chat Board</h4>
      <a href="index.html" class="btn btn-outline-secondary btn-sm">‚Üê Back</a>
    </div>

    <!-- Search Bar -->
    <input type="text" id="searchInput" class="form-control search-box" placeholder="üîç Search messages..." />

    <!-- Chat Messages -->
    <div id="chatMessages" class="mb-4" style="max-height: 400px; overflow-y: auto;"></div>

    <!-- Message Form -->
    <form id="messageForm" class="d-flex flex-column gap-2">
      <div class="d-flex gap-2">
        <input type="text" id="messageInput" class="form-control" placeholder="Type your message..." />
        <input type="file" id="fileInput" class="form-control" style="max-width: 200px;" />
        <button type="submit" class="btn btn-primary">Send</button>
      </div>
      <div id="filePreview"></div>
    </form>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user) window.location.href = "login.html";

    const chatBox = document.getElementById("chatMessages");
    const messageForm = document.getElementById("messageForm");
    const searchInput = document.getElementById("searchInput");
    const fileInput = document.getElementById("fileInput");
    const filePreview = document.getElementById("filePreview");

    // üñºÔ∏è Show filename before upload
    fileInput.addEventListener("change", () => {
      filePreview.textContent = fileInput.files.length > 0
        ? `üìé Selected: ${fileInput.files[0].name}`
        : "";
    });

    // üîΩ Auto-scroll to bottom
    function scrollToBottom() {
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // üß≠ Load all messages (chronological order)
    async function loadMessages(search = "", autoScroll = false) {
      try {
        const res = await fetch(`/api/faqs?search=${encodeURIComponent(search)}`);
        const data = await res.json();

        chatBox.innerHTML = "";
        if (!Array.isArray(data) || data.length === 0) {
          chatBox.innerHTML = `<div class="text-center text-muted my-3">No messages yet.</div>`;
          return;
        }

        // Sort oldest ‚Üí newest
        data.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));

        data.forEach(msg => {
          const isOwner = msg.created_by_user_id === user.user_id;
          const isAdmin = user.role_id === 1;
          const safeText = escapeHtml(msg.question || "");
          const sender = escapeHtml(msg.username || "User");
          const time = msg.created_at ? new Date(msg.created_at).toLocaleString() : "‚Äî";

          let fileUrl = msg.file_url || msg.fileUrl || null;
          if (fileUrl && !fileUrl.startsWith("http")) {
            fileUrl = `${window.location.origin}${fileUrl.startsWith("/") ? fileUrl : "/" + fileUrl}`;
          }

          const messageWrapper = document.createElement("div");
          messageWrapper.className = "message-wrapper " + (isOwner ? "justify-content-end" : "justify-content-start");

          const messageDiv = document.createElement("div");
          messageDiv.className = `message ${isOwner ? "message-right" : "message-left"}`;

          let attachmentHTML = "";
          if (fileUrl) {
            if (/\.(jpg|jpeg|png|gif|bmp|webp)$/i.test(fileUrl)) {
              attachmentHTML = `<img src="${fileUrl}" alt="Image" onerror="this.onerror=null;this.replaceWith(document.createTextNode('üìé [Image not found]'));">`;
            } else {
              const filename = fileUrl.split("/").pop();
              attachmentHTML = `<a href="${fileUrl}" target="_blank" class="file-link">${filename}</a>`;
            }
          }

          messageDiv.innerHTML = `
            <div class="message-header">
              ${isOwner ? "<span class='text-primary'>You</span>" : sender}
            </div>
            <div>${safeText}</div>
            ${attachmentHTML}
            <div class="timestamp">${time}</div>
            ${(isOwner || isAdmin)
              ? `<div class="mt-1">
                  <button class="btn btn-sm btn-warning edit-btn" data-id="${msg.faq_id}" data-text="${safeText}">‚úèÔ∏è</button>
                  <button class="btn btn-sm btn-danger delete-btn" data-id="${msg.faq_id}">üóëÔ∏è</button>
                </div>`
              : ""}
          `;

          messageWrapper.appendChild(messageDiv);
          chatBox.appendChild(messageWrapper);
        });

        attachEventListeners();

        // ‚¨áÔ∏è Scroll to bottom after rendering
        if (autoScroll) scrollToBottom();
      } catch (err) {
        console.error("Error loading messages:", err);
        chatBox.innerHTML = `<div class="alert alert-danger">Failed to load messages.</div>`;
      }
    }

    // ‚úèÔ∏è Edit/Delete buttons
    function attachEventListeners() {
      document.querySelectorAll(".edit-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const newText = prompt("Edit your message:", btn.dataset.text);
          if (newText !== null) updateMessage(btn.dataset.id, newText);
        });
      });

      document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          if (confirm("Delete this message?")) {
            await fetch(`/api/faqs/${btn.dataset.id}`, {
              method: "DELETE",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ user_id: user.user_id, role_id: user.role_id })
            });
            loadMessages(searchInput.value, true);
          }
        });
      });
    }

    async function updateMessage(id, newText) {
      await fetch(`/api/faqs/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question: newText, user_id: user.user_id, role_id: user.role_id })
      });
      loadMessages(searchInput.value, true);
    }

    // ‚ûï Send text or file
    messageForm.addEventListener("submit", async e => {
      e.preventDefault();
      const text = document.getElementById("messageInput").value.trim();
      const file = fileInput.files[0];
      if (!text && !file) return alert("Please enter a message or select a file.");

      const formData = new FormData();
      formData.append("question", text);
      formData.append("user_id", user.user_id);
      formData.append("username", user.username);
      if (file) formData.append("file", file);

      try {
        await fetch("/api/faqs", { method: "POST", body: formData });
        messageForm.reset();
        filePreview.textContent = "";
        // üü¶ Reload & scroll to bottom after sending
        loadMessages(searchInput.value, true);
      } catch (err) {
        console.error("Failed to send message:", err);
      }
    });

    // üîç Live search
    searchInput.addEventListener("input", () => loadMessages(searchInput.value));

    // üßπ Escape HTML safely
    function escapeHtml(unsafe) {
      return unsafe
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // üîÑ Auto-refresh (keep bottom scroll if user is near bottom)
    setInterval(() => {
      const nearBottom = chatBox.scrollHeight - chatBox.scrollTop - chatBox.clientHeight < 100;
      loadMessages(searchInput.value, nearBottom);
    }, 5000);

    // üöÄ Initial load ‚Üí scroll to bottom
    loadMessages("", true);
  </script>
</body>
</html>
