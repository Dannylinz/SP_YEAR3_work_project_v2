<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meganet Chat Board üí¨</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background: #f4f6f9;
      font-family: 'Poppins', sans-serif;
    }

    .chat-container {
      max-width: 800px;
      margin: 40px auto;
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      padding: 25px;
    }

    .message-wrapper {
      display: flex;
      margin-bottom: 12px;
    }

    .message {
      max-width: 70%;
      padding: 10px 15px;
      border-radius: 15px;
      word-wrap: break-word;
    }

    .message-left {
      background: #f1f3f6;
      align-self: flex-start;
      border-top-left-radius: 0;
    }

    .message-right {
      background: #cfe2ff;
      margin-left: auto;
      align-self: flex-end;
      border-top-right-radius: 0;
      text-align: right;
    }

    .message-header {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 5px;
    }

    .timestamp {
      font-size: 0.75rem;
      color: #888;
      margin-top: 4px;
    }

    .search-box {
      margin-bottom: 20px;
    }

    .btn-sm {
      font-size: 0.75rem;
      padding: 2px 6px;
    }

    .text-muted-small {
      font-size: 0.8rem;
      color: #888;
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="text-primary fw-bold">üí¨ Meganet Chat Board</h4>
      <a href="index.html" class="btn btn-outline-secondary btn-sm">‚Üê Back</a>
    </div>

    <!-- Search Bar -->
    <input type="text" id="searchInput" class="form-control search-box" placeholder="üîç Search messages..." />

    <!-- Chat Messages -->
    <div id="chatMessages" class="mb-4" style="max-height: 400px; overflow-y: auto;"></div>

    <!-- Message Form -->
    <form id="messageForm" class="d-flex gap-2">
      <input type="text" id="messageInput" class="form-control" placeholder="Type your message..." required />
      <button type="submit" class="btn btn-primary">Send</button>
    </form>
  </div>

  <!-- Edit Modal -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Message</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <textarea id="editMessageText" class="form-control" rows="3"></textarea>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="saveEditBtn" class="btn btn-success">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user) {
      window.location.href = "login.html";
    }

    const chatBox = document.getElementById("chatMessages");
    const messageForm = document.getElementById("messageForm");
    const searchInput = document.getElementById("searchInput");
    const editModal = new bootstrap.Modal(document.getElementById("editModal"));
    const editMessageText = document.getElementById("editMessageText");
    let editId = null;

    // üß≠ Load all messages
    async function loadMessages(search = "") {
      try {
        const res = await fetch(`/api/faqs?search=${encodeURIComponent(search)}`);
        const data = await res.json();

        chatBox.innerHTML = "";
        if (!Array.isArray(data) || data.length === 0) {
          chatBox.innerHTML = `<div class="text-center text-muted my-3">No messages yet.</div>`;
          return;
        }

        data.forEach(msg => {
          const isOwner = msg.created_by_user_id === user.user_id;
          const isAdmin = user.role_id === 1;
          const safeText = escapeHtml(msg.question);
          const sender = escapeHtml(msg.username || "User");
          const time = msg.created_at ? new Date(msg.created_at).toLocaleString() : "‚Äî";

          const messageWrapper = document.createElement("div");
          messageWrapper.className = "message-wrapper " + (isOwner ? "justify-content-end" : "justify-content-start");

          const messageDiv = document.createElement("div");
          messageDiv.className = `message ${isOwner ? "message-right" : "message-left"}`;

          messageDiv.innerHTML = `
            <div class="message-header">
              ${isOwner ? "<span class='text-primary'>You</span>" : sender}
            </div>
            <div>${safeText}</div>
            <div class="timestamp">${time}</div>
            ${(isOwner || isAdmin)
              ? `<div class="mt-1">
                  <button class="btn btn-sm btn-warning edit-btn" data-id="${msg.faq_id}" data-text="${safeText}">‚úèÔ∏è</button>
                  <button class="btn btn-sm btn-danger delete-btn" data-id="${msg.faq_id}">üóëÔ∏è</button>
                </div>`
              : ""}
          `;

          messageWrapper.appendChild(messageDiv);
          chatBox.appendChild(messageWrapper);
        });

        attachEventListeners();
        const isNearBottom = chatBox.scrollHeight - chatBox.scrollTop - chatBox.clientHeight < 50;
if (isNearBottom) {
  chatBox.scrollTop = chatBox.scrollHeight;
} // auto-scroll to bottom
      } catch (err) {
        console.error("Error loading messages:", err);
        chatBox.innerHTML = `<div class="alert alert-danger">Failed to load messages.</div>`;
      }
    }

    // ‚úèÔ∏è Attach edit/delete events
    function attachEventListeners() {
      document.querySelectorAll(".edit-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          editId = btn.dataset.id;
          editMessageText.value = btn.dataset.text;
          editModal.show();
        });
      });

      document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          if (confirm("Delete this message?")) {
            await fetch(`/api/faqs/${btn.dataset.id}`, {
              method: "DELETE",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ user_id: user.user_id, role_id: user.role_id })
            });
            loadMessages();
          }
        });
      });
    }

    // ‚ûï Add message
    messageForm.addEventListener("submit", async e => {
      e.preventDefault();
      const text = document.getElementById("messageInput").value.trim();
      if (!text) return;

      try {
        await fetch("/api/faqs", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question: text, user_id: user.user_id, username: user.username })
        });
        messageForm.reset();
        loadMessages();
      } catch (err) {
        console.error("Failed to send message:", err);
      }
    });

    // üíæ Save edited message
    document.getElementById("saveEditBtn").addEventListener("click", async () => {
      const newText = editMessageText.value.trim();
      if (!newText) return;

      try {
        await fetch(`/api/faqs/${editId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question: newText, user_id: user.user_id, role_id: user.role_id })
        });
        editModal.hide();
        loadMessages();
      } catch (err) {
        console.error("Failed to edit message:", err);
      }
    });

    // üîç Live search
    searchInput.addEventListener("input", () => loadMessages(searchInput.value));

    // üßπ Escape HTML safely
    function escapeHtml(unsafe) {
      return unsafe
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // üîÑ Auto-refresh every 5 seconds
    setInterval(() => loadMessages(searchInput.value), 5000);

    // üöÄ Initial load
    loadMessages();
  </script>
</body>
</html>
