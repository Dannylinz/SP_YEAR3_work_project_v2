<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meganet Chat Board üí¨</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background: #f4f6f9;
      font-family: 'Poppins', sans-serif;
    }

    .chat-container {
      max-width: 800px;
      margin: 40px auto;
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      padding: 25px;
    }

    .message-wrapper {
      display: flex;
      margin-bottom: 12px;
    }

    .message {
      max-width: 70%;
      padding: 10px 15px;
      border-radius: 15px;
      word-wrap: break-word;
    }

    .message-left {
      background: #f1f3f6;
      align-self: flex-start;
      border-top-left-radius: 0;
    }

    .message-right {
      background: #cfe2ff;
      margin-left: auto;
      align-self: flex-end;
      border-top-right-radius: 0;
      text-align: right;
    }

    .message img {
      max-width: 200px;
      border-radius: 10px;
      margin-top: 5px;
      cursor: pointer;
      transition: transform 0.2s ease-in-out;
    }

    .message img:hover {
      transform: scale(1.05);
    }

    .file-link {
      display: block;
      color: #0d6efd;
      text-decoration: underline;
      margin-top: 5px;
      word-break: break-all;
    }

    .message-header {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 5px;
    }

    .timestamp {
      font-size: 0.75rem;
      color: #888;
      margin-top: 4px;
    }

    .search-box {
      margin-bottom: 20px;
    }

    .btn-sm {
      font-size: 0.75rem;
      padding: 2px 6px;
    }

    #filePreview {
      font-size: 0.8rem;
      color: #555;
      margin-top: 4px;
    }

    /* üîç Zoom modal */
    #imgModal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      justify-content: center;
      align-items: center;
      cursor: zoom-out;
    }

    #imgModal img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.4);
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="text-primary fw-bold">üí¨ Meganet Chat Board</h4>
      <a href="index.html" class="btn btn-outline-secondary btn-sm">‚Üê Back</a>
    </div>

    <!-- Search Bar -->
    <input type="text" id="searchInput" class="form-control search-box" placeholder="üîç Search messages..." />

    <!-- Chat Messages -->
    <div id="chatMessages" class="mb-4" style="max-height: 400px; overflow-y: auto;"></div>

    <!-- Message Form -->
    <form id="messageForm" class="d-flex flex-column gap-2">
      <div class="d-flex gap-2">
        <input type="text" id="messageInput" class="form-control" placeholder="Type your message..." />
        <input type="file" id="fileInput" class="form-control" style="max-width: 200px;" />
        <button type="submit" class="btn btn-primary">Send</button>
      </div>
      <div id="filePreview"></div>
    </form>
  </div>

  <!-- üñºÔ∏è Image Zoom Modal -->
  <div id="imgModal">
    <img id="modalImg" src="" alt="Zoomed image" />
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user) window.location.href = "login.html";

    const chatBox = document.getElementById("chatMessages");
    const messageForm = document.getElementById("messageForm");
    const searchInput = document.getElementById("searchInput");
    const fileInput = document.getElementById("fileInput");
    const filePreview = document.getElementById("filePreview");
    const imgModal = document.getElementById("imgModal");
    const modalImg = document.getElementById("modalImg");

    // üñºÔ∏è Show filename before upload
    fileInput.addEventListener("change", () => {
      filePreview.textContent = fileInput.files.length > 0
        ? `üìé Selected: ${fileInput.files[0].name}`
        : "";
    });

    // üîΩ Auto-scroll to bottom
    function scrollToBottom() {
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // üß≠ Load messages
    async function loadMessages(search = "", autoScroll = false) {
      try {
        const res = await fetch(`/api/faqs?search=${encodeURIComponent(search)}`);
        const data = await res.json();
        chatBox.innerHTML = "";

        if (!Array.isArray(data) || data.length === 0) {
          chatBox.innerHTML = `<div class="text-center text-muted my-3">No messages yet.</div>`;
          return;
        }

        data.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));

        data.forEach(msg => {
          const isOwner = msg.created_by_user_id === user.user_id;
          const isAdmin = user.role_id === 1;
          const safeText = escapeHtml(msg.question || "");
          const sender = escapeHtml(msg.username || "User");
          const time = msg.created_at ? new Date(msg.created_at).toLocaleString() : "‚Äî";

          let fileUrl = msg.file_url || msg.fileUrl || null;
          if (fileUrl && !fileUrl.startsWith("http")) {
            fileUrl = `${window.location.origin}${fileUrl.startsWith("/") ? fileUrl : "/" + fileUrl}`;
          }

          const messageWrapper = document.createElement("div");
          messageWrapper.className = "message-wrapper " + (isOwner ? "justify-content-end" : "justify-content-start");

          const messageDiv = document.createElement("div");
          messageDiv.className = `message ${isOwner ? "message-right" : "message-left"}`;

          let attachmentHTML = "";
          if (fileUrl) {
            if (/\.(jpg|jpeg|png|gif|bmp|webp)$/i.test(fileUrl)) {
              attachmentHTML = `<img src="${fileUrl}" alt="Image" class="zoomable-img" onerror="this.onerror=null;this.replaceWith(document.createTextNode('üìé [Image not found]'));">`;
            } else {
              const filename = fileUrl.split("/").pop();
              attachmentHTML = `<a href="${fileUrl}" target="_blank" class="file-link">${filename}</a>`;
            }
          }

          messageDiv.innerHTML = `
            <div class="message-header">
              ${isOwner ? "<span class='text-primary'>You</span>" : sender}
            </div>
            <div>${safeText}</div>
            ${attachmentHTML}
            <div class="timestamp">${time}</div>
            ${(isOwner || isAdmin)
              ? `<div class="mt-1">
                  <button class="btn btn-sm btn-warning edit-btn" 
                    data-id="${msg.faq_id}" 
                    data-text="${safeText}"
                    data-file="${fileUrl || ''}">‚úèÔ∏è</button>
                  <button class="btn btn-sm btn-danger delete-btn" data-id="${msg.faq_id}">üóëÔ∏è</button>
                </div>` : ""}
          `;

          messageWrapper.appendChild(messageDiv);
          chatBox.appendChild(messageWrapper);
        });

        attachEventListeners();
        enableImageZoom();
        if (autoScroll) scrollToBottom();
      } catch (err) {
        console.error("Error loading messages:", err);
        chatBox.innerHTML = `<div class="alert alert-danger">Failed to load messages.</div>`;
      }
    }

    // üñºÔ∏è Image Zoom Handler
    function enableImageZoom() {
      document.querySelectorAll(".zoomable-img").forEach(img => {
        img.addEventListener("click", () => {
          modalImg.src = img.src;
          imgModal.style.display = "flex";
        });
      });
    }

    imgModal.addEventListener("click", () => {
      imgModal.style.display = "none";
      modalImg.src = "";
    });

    // ‚úèÔ∏è Edit/Delete buttons
    function attachEventListeners() {
      // üü° EDIT WITH FILE SUPPORT
      document.querySelectorAll(".edit-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const oldText = btn.dataset.text || "";
          const oldFile = btn.dataset.file || "";
          
          const newText = prompt("Edit your message text:", oldText);
          if (newText === null) return;

          // Create a hidden file input for optional file change
          const newFileInput = document.createElement("input");
          newFileInput.type = "file";
          newFileInput.style.display = "none";
          document.body.appendChild(newFileInput);

          if (confirm("Do you want to update or replace the attached file/image?")) {
            newFileInput.click();
          }

          newFileInput.addEventListener("change", async () => {
            const formData = new FormData();
            formData.append("question", newText);
            formData.append("user_id", user.user_id);
            formData.append("role_id", user.role_id);

            if (newFileInput.files.length > 0) {
              formData.append("file", newFileInput.files[0]);
            }

            try {
              await fetch(`/api/faqs/${btn.dataset.id}`, {
                method: "PUT",
                body: formData,
              });
              loadMessages(searchInput.value, true);
            } catch (err) {
              console.error("Failed to update message:", err);
            } finally {
              document.body.removeChild(newFileInput);
            }
          });

          // If user chooses not to update file
          setTimeout(async () => {
            if (!newFileInput.files.length) {
              const res = await fetch(`/api/faqs/${btn.dataset.id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ question: newText, user_id: user.user_id, role_id: user.role_id })
              });
              if (res.ok) loadMessages(searchInput.value, true);
              document.body.removeChild(newFileInput);
            }
          }, 1500);
        });
      });

      // üî¥ DELETE
      document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          if (confirm("Delete this message?")) {
            await fetch(`/api/faqs/${btn.dataset.id}`, {
              method: "DELETE",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ user_id: user.user_id, role_id: user.role_id })
            });
            loadMessages(searchInput.value, true);
          }
        });
      });
    }

    // ‚ûï Send new message
    messageForm.addEventListener("submit", async e => {
      e.preventDefault();
      const text = document.getElementById("messageInput").value.trim();
      const file = fileInput.files[0];
      if (!text && !file) return alert("Please enter a message or select a file.");

      const formData = new FormData();
      formData.append("question", text);
      formData.append("user_id", user.user_id);
      formData.append("username", user.username);
      if (file) formData.append("file", file);

      try {
        await fetch("/api/faqs", { method: "POST", body: formData });
        messageForm.reset();
        filePreview.textContent = "";
        loadMessages(searchInput.value, true);
      } catch (err) {
        console.error("Failed to send message:", err);
      }
    });

    // üîç Live search
    searchInput.addEventListener("input", () => loadMessages(searchInput.value));

    // üßπ Escape HTML safely
    function escapeHtml(unsafe) {
      return unsafe
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // üîÑ Auto-refresh
    setInterval(() => {
      const nearBottom = chatBox.scrollHeight - chatBox.scrollTop - chatBox.clientHeight < 100;
      loadMessages(searchInput.value, nearBottom);
    }, 5000);

    // üöÄ Initial load
    loadMessages("", true);
  </script>
</body>
</html>
